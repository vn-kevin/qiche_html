(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-a2d20f46"],{"05af":function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"create-video-container"},[i("div",{staticClass:"content"},["video"===e.action?[e.assetUrl?i("video",{attrs:{src:e.assetUrl,controls:""}}):i("div",{staticClass:"placeholder"},[e._v("视频将在这里显示")])]:"gif"===e.action?[e.assetUrl?i("img",{attrs:{src:e.assetUrl,alt:"Generated GIF"}}):i("div",{staticClass:"placeholder"},[e._v("GIF 将在这里显示")])]:[i("div",{staticClass:"placeholder"},[e._v("选择生成类型")])]],2),e._v(" "),e.loading?i("div",{staticClass:"loading"},[i("el-progress",{attrs:{percentage:e.progress,status:e.progressStatus}}),e._v(" "),i("p",[e._v(e._s(e.loadingText))])],1):e._e()])},a=[],s=i("2d63"),r=(i("ac6a"),i("5df3"),i("43ca")),o=(i("96cf"),i("3b8d")),c=i("cd40"),h=i.n(c),l={name:"CreateVideo",data:function(){return{imgArr:[],ffmpeg:null,videoTime:10,assetUrl:"",action:"video",loading:!1,progress:0,progressStatus:"",loadingText:""}},mounted:function(){this.checkVideoFormatSupport()},methods:{createVideo:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t){var i,n,a,s,o,c,h,l,u,d,g,v,f,m,p,b,w,y,x,O,k,I,T=arguments;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:if(i=T.length>1&&void 0!==T[1]?T[1]:{},n=i.type,a=void 0===n?"video":n,s=i.duration,o=void 0===s?null:s,c=i.quality,h=void 0===c?10:c,l=i.width,u=void 0===l?600:l,d=i.height,g=void 0===d?400:d,v=i.fps,f=void 0===v?24:v,m=i.useWorker,p=void 0===m||m,b=i.showProgress,w=void 0===b||b,y=i.enableTransition,x=void 0===y||y,O=i.videoFormat,k=void 0===O?"mp4":O,t&&0!==t.length){e.n=1;break}return this.$message.error("请选择图片"),e.a(2,Promise.reject(new Error("图片数组为空")));case 1:if(this.action=a,this.imgArr=t,null!==o&&(this.videoTime=o),e.p=2,"gif"!==a){e.n=4;break}return e.n=3,this._handleGifGeneration(t,{quality:h,width:u,height:g,useWorker:p,showProgress:w});case 3:return e.a(2,e.v);case 4:return e.n=5,this._handleVideoGeneration(t,{width:u,height:g,fps:f,showProgress:w,enableTransition:x,videoFormat:k});case 5:return e.a(2,e.v);case 6:e.n=8;break;case 7:throw e.p=7,I=e.v,w&&this.$message.error("".concat("gif"===a?"GIF":"视频","生成失败: ").concat(I.message)),I;case 8:return e.a(2)}}),e,this,[[2,7]])})));function t(t){return e.apply(this,arguments)}return t}(),_handleVideoGeneration:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i){var n,a,s,c,h,l,u=this;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:return n=i.width,a=i.height,s=i.fps,c=i.showProgress,h=i.enableTransition,l=i.videoFormat,c&&(this.progress=0),e.a(2,new Promise(function(){var e=Object(o["a"])(Object(r["a"])().m((function e(i,o){var d,g,v,f,m,p,b,w,y,x,O,k,I,T,j;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:if(e.p=0,d=document.createElement("canvas"),g=d.getContext("2d"),d.width=n,d.height=a,d.captureStream){e.n=1;break}throw new Error("您的浏览器不支持 Canvas.captureStream API");case 1:return v=d.captureStream(s),f=u.selectVideoFormat(l),m=f.mimeType,f.fileExtension,p=f.contentType,b=new MediaRecorder(v,{mimeType:m}),w=[],b.ondataavailable=function(e){e.data.size>0&&w.push(e.data)},b.onstop=function(){var e=new Blob(w,{type:p});u.assetUrl=URL.createObjectURL(e),c&&(u.progress=100),i(u.assetUrl)},b.onerror=function(e){o(e)},b.start(),e.n=2,u.preloadImages(t,n,a);case 2:y=e.v,x=0,O=Math.floor(u.videoTime*s/t.length),h&&t.length>1&&(x=Math.floor(.5*s),O=Math.floor(u.videoTime*s/t.length)-x),k=1e3/s,I=0;case 3:if(!(I<t.length)){e.n=8;break}c&&(u.progress=Math.round(I/t.length*90)),T=0;case 4:if(!(T<O)){e.n=6;break}return g.clearRect(0,0,n,a),g.globalAlpha=1,g.drawImage(y[I],0,0,n,a),e.n=5,u.delay(k);case 5:T++,e.n=4;break;case 6:if(!(h&&I<t.length-1)){e.n=7;break}return e.n=7,u.drawTransition(g,y[I],y[I+1],x,k,n,a);case 7:I++,e.n=3;break;case 8:b.stop(),e.n=10;break;case 9:e.p=9,j=e.v,o(j);case 10:return e.a(2)}}),e,null,[[0,9]])})));return function(t,i){return e.apply(this,arguments)}}()))}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}(),_handleGifGeneration:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i){var n,a,s,o,c;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:if(n=i.quality,a=i.width,s=i.height,o=i.useWorker,c=i.showProgress,c&&(this.progress=0),!o){e.n=5;break}return e.p=1,e.n=2,this._createGifWithWorker(t,{quality:n,width:a,height:s,showProgress:c});case 2:return e.a(2,e.v);case 3:return e.p=3,e.v,e.n=4,this._createGifWithoutWorker(t,{quality:n,width:a,height:s,showProgress:c});case 4:return e.a(2,e.v);case 5:return e.n=6,this._createGifWithoutWorker(t,{quality:n,width:a,height:s,showProgress:c});case 6:return e.a(2,e.v);case 7:return e.a(2)}}),e,this,[[1,3]])})));function t(t,i){return e.apply(this,arguments)}return t}(),_createGifWithWorker:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i){var n,a,s,c,l=this;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:return n=i.quality,a=i.width,s=i.height,c=i.showProgress,e.a(2,new Promise(function(){var e=Object(o["a"])(Object(r["a"])().m((function e(i,o){var u,d,g,v,f;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:e.p=0,u=new h.a({workers:2,quality:n,width:a,height:s,workerScript:"/gif.worker.js"}),d=1e3*l.videoTime/t.length,g=0;case 1:if(!(g<t.length)){e.n=4;break}return c&&(l.progress=Math.round(g/t.length*80)),e.n=2,l.imageToCanvas(t[g],a,s);case 2:v=e.v,u.addFrame(v,{delay:d});case 3:g++,e.n=1;break;case 4:u.on("progress",(function(e){c&&(l.progress=80+Math.round(20*e))})),u.on("finished",(function(e){l.assetUrl=URL.createObjectURL(e),c&&(l.progress=100),i(l.assetUrl)})),u.on("abort",(function(){o(new Error("GIF 生成被中断"))})),u.render(),e.n=6;break;case 5:e.p=5,f=e.v,o(f);case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,i){return e.apply(this,arguments)}}()))}}),e)})));function t(t,i){return e.apply(this,arguments)}return t}(),_createGifWithoutWorker:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i){var n,a,s,c,l=this;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:return n=i.quality,a=i.width,s=i.height,c=i.showProgress,e.a(2,new Promise(function(){var e=Object(o["a"])(Object(r["a"])().m((function e(i,o){var u,d,g,v,f;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:e.p=0,u=new h.a({workers:0,quality:n,width:a,height:s}),d=1e3*l.videoTime/t.length,g=0;case 1:if(!(g<t.length)){e.n=4;break}return c&&(l.progress=Math.round(g/t.length*80)),e.n=2,l.imageToCanvas(t[g],a,s);case 2:v=e.v,u.addFrame(v,{delay:d});case 3:g++,e.n=1;break;case 4:u.on("progress",(function(e){c&&(l.progress=80+Math.round(20*e))})),u.on("finished",(function(e){l.assetUrl=URL.createObjectURL(e),c&&(l.progress=100),i(l.assetUrl)})),u.on("abort",(function(){o(new Error("GIF 生成被中断"))})),u.render(),e.n=6;break;case 5:e.p=5,f=e.v,o(f);case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,i){return e.apply(this,arguments)}}()))}}),e)})));function t(t,i){return e.apply(this,arguments)}return t}(),imageToCanvas:function(e,t,i){return new Promise((function(n){var a=document.createElement("canvas"),s=a.getContext("2d");a.width=t,a.height=i;var r=new Image;r.onload=function(){s.drawImage(r,0,0,t,i),n(a)},r.src=e}))},drawImageOnCanvas:function(e,t,i,n){return new Promise((function(a){var s=new Image;s.onload=function(){e.clearRect(0,0,i,n),e.drawImage(s,0,0,i,n),a()},s.src=t}))},preloadImages:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i,n){var a;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:return a=t.map((function(e){return new Promise((function(t,i){var n=new Image;n.onload=function(){return t(n)},n.onerror=i,n.src=e}))})),e.n=1,Promise.all(a);case 1:return e.a(2,e.v)}}),e)})));function t(t,i,n){return e.apply(this,arguments)}return t}(),drawTransition:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(t,i,n,a,s,o,c){var h,l,u,d;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:h=0;case 1:if(!(h<a)){e.n=3;break}return l=h/a,u=1-l,d=l,t.clearRect(0,0,o,c),t.globalAlpha=u,t.drawImage(i,0,0,o,c),t.globalAlpha=d,t.drawImage(n,0,0,o,c),e.n=2,this.delay(s);case 2:h++,e.n=1;break;case 3:t.globalAlpha=1;case 4:return e.a(2)}}),e,this)})));function t(t,i,n,a,s,r,o){return e.apply(this,arguments)}return t}(),selectVideoFormat:function(e){var t={mp4:[{mimeType:"video/mp4;codecs=h264",contentType:"video/mp4",fileExtension:"mp4"},{mimeType:"video/mp4;codecs=avc1.42E01E",contentType:"video/mp4",fileExtension:"mp4"},{mimeType:"video/mp4",contentType:"video/mp4",fileExtension:"mp4"}],webm:[{mimeType:"video/webm;codecs=vp9",contentType:"video/webm",fileExtension:"webm"},{mimeType:"video/webm;codecs=vp8",contentType:"video/webm",fileExtension:"webm"},{mimeType:"video/webm",contentType:"video/webm",fileExtension:"webm"}]};if("auto"===e){var i,n=Object(s["a"])(t.mp4);try{for(n.s();!(i=n.n()).done;){var a=i.value;if(MediaRecorder.isTypeSupported(a.mimeType))return a}}catch(m){n.e(m)}finally{n.f()}var r,o=Object(s["a"])(t.webm);try{for(o.s();!(r=o.n()).done;){var c=r.value;if(MediaRecorder.isTypeSupported(c.mimeType))return c}}catch(m){o.e(m)}finally{o.f()}}else{var h,l=t[e]||t.webm,u=Object(s["a"])(l);try{for(u.s();!(h=u.n()).done;){var d=h.value;if(MediaRecorder.isTypeSupported(d.mimeType))return d}}catch(m){u.e(m)}finally{u.f()}if("webm"!==e){var g,v=Object(s["a"])(t.webm);try{for(v.s();!(g=v.n()).done;){var f=g.value;if(MediaRecorder.isTypeSupported(f.mimeType))return f}}catch(m){v.e(m)}finally{v.f()}}}throw new Error("当前浏览器不支持视频录制功能")},checkVideoFormatSupport:function(){var e=["video/mp4;codecs=h264","video/mp4;codecs=avc1.42E01E","video/mp4","video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"],t=e.filter((function(e){return MediaRecorder.isTypeSupported(e)}));return t},delay:function(e){return new Promise((function(t){return setTimeout(t,e)}))},generateVideo:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(){var t;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:if(this.imgArr&&0!==this.imgArr.length){e.n=1;break}return this.$message.error("请先选择图片"),e.a(2);case 1:return this.loading=!0,this.progress=0,this.progressStatus="active",this.loadingText="正在生成视频...",e.p=2,e.n=3,this.createVideo(this.imgArr,{type:"video",showProgress:!0});case 3:this.loading=!1,this.progressStatus="success",this.loadingText="视频生成成功!",this.$message.success("视频生成成功!"),e.n=5;break;case 4:e.p=4,t=e.v,this.loading=!1,this.progress=0,this.progressStatus="exception",this.loadingText="视频生成失败: "+t.message,this.$message.error("视频生成失败: "+t.message);case 5:return e.a(2)}}),e,this,[[2,4]])})));function t(){return e.apply(this,arguments)}return t}(),generateGif:function(){var e=Object(o["a"])(Object(r["a"])().m((function e(){var t;return Object(r["a"])().w((function(e){while(1)switch(e.n){case 0:if(this.imgArr&&0!==this.imgArr.length){e.n=1;break}return this.$message.error("请先选择图片"),e.a(2);case 1:return this.loading=!0,this.progress=0,this.progressStatus="active",this.loadingText="正在生成 GIF...",e.p=2,e.n=3,this.createVideo(this.imgArr,{type:"gif",showProgress:!0});case 3:this.loading=!1,this.progressStatus="success",this.loadingText="GIF 生成成功!",this.$message.success("GIF 生成成功!"),e.n=5;break;case 4:e.p=4,t=e.v,this.loading=!1,this.progress=0,this.progressStatus="exception",this.loadingText="GIF 生成失败: "+t.message,this.$message.error("GIF 生成失败: "+t.message);case 5:return e.a(2)}}),e,this,[[2,4]])})));function t(){return e.apply(this,arguments)}return t}()}},u=l,d=(i("f779"),i("2877")),g=Object(d["a"])(u,n,a,!1,null,"1d30b842",null);t["default"]=g.exports},"0ade":function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"make-container"},[i("div",{staticClass:"main-content"},[i("div",{staticClass:"left-panel"},[["gif","video"].includes(e.currentTemplateType)?e._e():i("div",{staticClass:"canvas-tool-container"},[i("div",{staticClass:"canvas-controls"},[i("button",{staticClass:"btn-primary",attrs:{disabled:e.composing},on:{click:e.generateComposition}},[e._v("\n            "+e._s(e.composing?"生成中...":"生成合成图")+"\n          ")]),e._v(" "),i("button",{staticClass:"btn-interactive",attrs:{disabled:!e.hasComposition},on:{click:e.toggleInteractiveMode}},[e._v("\n            "+e._s(e.isInteractiveMode?"退出编辑":"编辑模式")+"\n          ")]),e._v(" "),i("button",{staticClass:"btn-danger",attrs:{disabled:!e.isInteractiveMode||!e.hasSelectedObject},on:{click:e.deleteSelectedImage}},[e._v("\n            删除选中\n          ")]),e._v(" "),i("button",{staticClass:"btn-secondary",attrs:{disabled:!e.isInteractiveMode||!e.hasSelectedObject},on:{click:e.resetImageScale}},[e._v("\n            重置缩放\n          ")]),e._v(" "),i("button",{staticClass:"btn-secondary",attrs:{disabled:!e.hasComposition},on:{click:e.previewResult}},[e._v("\n            预览效果\n          ")]),e._v(" "),i("button",{staticClass:"btn-success",attrs:{disabled:!e.hasComposition},on:{click:e.downloadResult}},[e._v("\n            下载图片\n          ")]),e._v(" "),i("button",{staticClass:"btn-warning",on:{click:e.clearCanvas}},[e._v("\n            清空画布\n          ")])]),e._v(" "),i("div",{staticClass:"zoom-controls"},[i("button",{staticClass:"zoom-btn",attrs:{title:"缩小"},on:{click:e.zoomOut}},[e._v("-")]),e._v(" "),i("span",{staticClass:"zoom-level"},[e._v(e._s(Math.round(100*e.currentZoom))+"%")]),e._v(" "),i("button",{staticClass:"zoom-btn",attrs:{title:"放大"},on:{click:e.zoomIn}},[e._v("+")]),e._v(" "),i("button",{staticClass:"zoom-btn zoom-fit",attrs:{title:"适应画布"},on:{click:e.zoomToFit}},[e._v("适应")]),e._v(" "),i("button",{staticClass:"zoom-btn zoom-actual",attrs:{title:"实际大小"},on:{click:e.zoomToActualSize}},[e._v("1:1")])])]),e._v(" "),["gif","video"].includes(e.currentTemplateType)?i("div",{staticClass:"canvas-tool-container"},[i("div",{staticClass:"canvas-controls"},[i("button",{staticClass:"btn-primary",on:{click:e.createVideoFuns}},[e._v("\n            制作\n          ")])])]):e._e(),e._v(" "),["gif","video"].includes(e.currentTemplateType)?e._e():[i("canvas",{style:{background:"#fff"},attrs:{id:"canvasId","canvas-id":"canvasId"}})],e._v(" "),["gif","video"].includes(e.currentTemplateType)?i("div",[i("create-video",{ref:"createVideoRef"})],1):e._e(),e._v(" "),e.compositionStatus?i("div",{staticClass:"status-message",class:e.compositionStatus.type},[e._v("\n        "+e._s(e.compositionStatus.message)+"\n      ")]):e._e()],2),e._v(" "),i("div",{staticClass:"right-panel"},[i("div",{staticClass:"image-list"},[i("template-info",{attrs:{"template-type":e.currentTemplateType}}),e._v(" "),i("h3",{staticClass:"image-list-title"},[e._v("图片列表 ("+e._s(e.imageList.length)+")")]),e._v(" "),i("image-select-all",{attrs:{"is-all-selected":e.isAllSelected,"selected-count":e.selectedImages.length,"total-count":e.imageList.length},on:{toggle:e.toggleSelectAll}}),e._v(" "),i("image-grid",{attrs:{images:e.imageList,"selected-images":e.selectedImages},on:{"toggle-selection":e.toggleImageSelection}})],1)])])])},a=[],s=(i("28a5"),i("ac6a"),i("5df3"),i("6762"),i("2fdb"),i("43ca")),r=(i("96cf"),i("3b8d")),o=i("f8b7"),c=i("52c2"),h=i("9b5d"),l=i("ea6b"),u=i("b67c"),d=i("b829"),g=i("05af"),v={DEFAULT_WIDTH:600,DEFAULT_HEIGHT:600,MIN_ZOOM:.1,MAX_ZOOM:3,ZOOM_STEP:.1},f=3e3,m={name:"DiaryMake",components:{TemplateInfo:l["default"],ImageSelectAll:u["default"],ImageGrid:d["default"],CreateVideo:g["default"]},props:{actionType:{type:String,default:""}},data:function(){return{currentTemplateType:"",TEMPLATE_TYPE_MAP:h["TEMPLATE_TYPE_MAP"],imageList:[],selectedImages:[],photoCalendarList:[],canvasConfig:{width:v.DEFAULT_WIDTH,height:v.DEFAULT_HEIGHT},currentZoom:1,canvasZoomControls:null,composer:null,composing:!1,hasComposition:!1,isInteractiveMode:!1,compositionStatus:null}},computed:{isAllSelected:function(){return this.imageList.length>0&&this.selectedImages.length===this.imageList.length},hasSelectedObject:function(){return this.composer&&this.composer.getInteractiveCanvas()&&this.composer.getInteractiveCanvas().selectedObject},maxImagesForTemplate:function(){var e={nine_grid:9,compare:2,timeline:20};return e[this.currentTemplateType]||9}},mounted:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return e.n=1,this.initializeComponent();case 1:this.setupEventListeners();case 2:return e.a(2)}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),beforeDestroy:function(){this.cleanup()},methods:{createVideoFuns:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){var t,i,n,a,r=this;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return e.p=0,t=this.imageList.filter((function(e){return r.selectedImages.includes(e.id)})).map((function(e){return e.url})),e.n=1,this.convertImagesToBase64(t);case 1:i=e.v,n={type:"gif"===this.currentTemplateType?"gif":"video",quality:5,useWorker:!0},this.currentTemplateType,n.duration=4*t.length,this.$refs.createVideoRef&&this.$refs.createVideoRef.createVideo(i,n),e.n=3;break;case 2:e.p=2,a=e.v,this.$message.destroy(),this.$message.error("图片处理失败: "+a.message);case 3:return e.a(2)}}),e,this,[[0,2]])})));function t(){return e.apply(this,arguments)}return t}(),convertImagesToBase64:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(t){var i,n;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return i=c["loadImage"],n=t.map(function(){var e=Object(r["a"])(Object(s["a"])().m((function e(t,n){var a,r,o,c;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return e.p=0,e.n=1,i(t);case 1:return a=e.v,r=document.createElement("canvas"),o=r.getContext("2d"),r.width=a.naturalWidth,r.height=a.naturalHeight,o.drawImage(a,0,0),c=r.toDataURL("image/jpeg",.9),e.a(2,c);case 2:throw e.p=2,e.v,new Error("图片 ".concat(n+1," 加载失败"));case 3:return e.a(2)}}),e,null,[[0,2]])})));return function(t,i){return e.apply(this,arguments)}}()),e.n=1,Promise.all(n);case 1:return e.a(2,e.v)}}),e)})));function t(t){return e.apply(this,arguments)}return t}(),initializeComponent:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return this.currentTemplateType=this.$route.query.templateType||"compare",e.n=1,this.getOrderInfo();case 1:if(["gif","video"].includes(this.currentTemplateType)){e.n=2;break}return e.n=2,this.initializeCanvas();case 2:return e.a(2)}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),setupEventListeners:function(){this.keyboardHandler=this.handleKeyboard.bind(this),document.addEventListener("keydown",this.keyboardHandler)},cleanup:function(){this.resizeHandler&&window.removeEventListener("resize",this.resizeHandler),this.keyboardHandler&&document.removeEventListener("keydown",this.keyboardHandler),this.resizeTimeout&&clearTimeout(this.resizeTimeout)},getOrderInfo:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){var t,i,n,a,r,c,h,l=this;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return t=this.$route.query,i=t.orderId,n=t.templateType,e.n=1,Object(o["c"])(i);case 1:if(a=e.v,r=a.data,"timeline"!==n){e.n=3;break}return e.n=2,Object(o["b"])(r.diaryUid);case 2:c=e.v,h=c.data,this.photoCalendarList=h,h.map((function(e){e.images&&e.images.length>0&&e.images.map((function(t){l.imageList.push({date:e.date,id:t.id,url:t.photoAddress,name:t.photoAddress.split("/").pop()})}))})),e.n=4;break;case 3:this.imageList=r.images.map((function(e){return{id:e.id,url:e.photoAddress,name:e.photoAddress.split("/").pop()}}));case 4:return e.a(2)}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),initializeCanvas:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){var t,i;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return e.p=0,t=h["TEMPLATE_TYPE_MAP"][this.currentTemplateType],this.canvasConfig={width:parseInt(t.width)||v.DEFAULT_WIDTH,height:parseInt(t.height)||v.DEFAULT_HEIGHT},e.n=1,this.$nextTick();case 1:i=c["initCanvas"]("canvasId",this.canvasConfig.width,this.canvasConfig.height,{autoScale:!0,maxScale:1,containerSelector:".left-panel"}),this.composer=c["createAdvancedComposer"]("canvasId",this.currentTemplateType,{width:this.canvasConfig.width,height:this.canvasConfig.height,preserveAspectRatio:!0,enableInteractive:!0}),this.canvasZoomControls=c["addCanvasZoomControls"]("canvasId",{minScale:v.MIN_ZOOM,maxScale:v.MAX_ZOOM,zoomStep:v.ZOOM_STEP}),this.currentZoom=i.displayInfo.scale,this.setupResizeListener(),this.showStatus("画布初始化完成","success"),e.n=3;break;case 2:e.p=2,e.v,this.showStatus("画布初始化失败","error");case 3:return e.a(2)}}),e,this,[[0,2]])})));function t(){return e.apply(this,arguments)}return t}(),setupResizeListener:function(){var e=this;this.resizeHandler=function(){clearTimeout(e.resizeTimeout),e.resizeTimeout=setTimeout((function(){c["fitCanvasToContainer"]("canvasId",".left-panel",1);var t=c["getCanvasScale"]("canvasId");t&&(e.currentZoom=t.scale)}),300)},window.addEventListener("resize",this.resizeHandler)},clearCanvas:function(){try{c["initCanvas"]("canvasId",this.canvasConfig.width,this.canvasConfig.height),this.hasComposition=!1,this.isInteractiveMode=!1,this.composer=c["createAdvancedComposer"]("canvasId",this.currentTemplateType,{width:this.canvasConfig.width,height:this.canvasConfig.height,preserveAspectRatio:!0,enableInteractive:!0}),this.showStatus("画布已清空","info")}catch(e){this.showStatus("清空失败","error")}},generateComposition:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){var t,i;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:if(this.composer){e.n=1;break}return this.showStatus("合成管理器未初始化","error"),e.a(2);case 1:return this.composing=!0,this.showStatus("正在生成合成图...","info"),e.p=2,e.n=3,this.composer.generateComposition(this.selectedImages,this.imageList);case 3:t=e.v,t.success?(this.hasComposition=!0,this.showStatus(t.message,"success")):this.showStatus(t.message,"warning"),e.n=5;break;case 4:e.p=4,i=e.v,this.showStatus("合成失败: "+i.message,"error");case 5:return e.p=5,this.composing=!1,e.f(5);case 6:return e.a(2)}}),e,this,[[2,4,5,6]])})));function t(){return e.apply(this,arguments)}return t}(),toggleImageSelection:function(e){var t=this.selectedImages.indexOf(e);if(t>-1)this.selectedImages.splice(t,1);else{if(this.selectedImages.length>=this.maxImagesForTemplate){var i=this.TEMPLATE_TYPE_MAP[this.currentTemplateType].label;return void this.showStatus("".concat(i,"最多只能选择").concat(this.maxImagesForTemplate,"张图片"),"warning")}this.selectedImages.push(e)}},toggleSelectAll:function(){if(this.isAllSelected)this.selectedImages=[];else{var e=this.imageList.slice(0,this.maxImagesForTemplate).map((function(e){return e.id}));if(this.selectedImages=e,this.imageList.length>this.maxImagesForTemplate){var t=this.TEMPLATE_TYPE_MAP[this.currentTemplateType].label;this.showStatus("".concat(t,"最多支持").concat(this.maxImagesForTemplate,"张图片，已选择前").concat(this.maxImagesForTemplate,"张"),"info")}}},toggleInteractiveMode:function(){this.isInteractiveMode=!this.isInteractiveMode,this.composer&&this.composer.setEditMode(this.isInteractiveMode);var e=this.isInteractiveMode?"进入编辑模式：可以拖拽、调整大小和滚轮缩放":"退出编辑模式";this.showStatus(e,"info")},deleteSelectedImage:function(){var e=this.composer.getInteractiveCanvas();e&&e.selectedObject&&(e.deleteSelected(),this.showStatus("已删除选中图片","info"))},resetImageScale:function(){var e=this.composer.getInteractiveCanvas();e&&e.selectedObject&&(e.resetSelectedScale(),this.showStatus("已重置图片缩放","info"))},zoomOut:function(){this.executeZoomAction("zoomOut")},zoomIn:function(){this.executeZoomAction("zoomIn")},zoomToFit:function(){this.executeZoomAction("zoomToFit")},zoomToActualSize:function(){this.executeZoomAction("zoomToActualSize")},executeZoomAction:function(e){this.canvasZoomControls&&(this.canvasZoomControls[e](),this.currentZoom=this.canvasZoomControls.getZoomLevel())},previewResult:function(){if(this.hasComposition&&this.composer){var e=this.composer.exportComposition("png",.9),t=window.open();t.document.write('\n        <html>\n          <head><title>合成预览</title></head>\n          <body style="margin:0;padding:20px;background:#f5f5f5;text-align:center;">\n            <h2>合成效果预览</h2>\n            <img src="'.concat(e,'" style="max-width:100%;border:1px solid #ddd;border-radius:8px;" />\n            <br/><br/>\n            <button onclick="window.close()" style="padding:10px 20px;font-size:14px;">关闭预览</button>\n          </body>\n        </html>\n      '))}},downloadResult:function(){if(this.hasComposition&&this.composer)try{var e="composition_".concat(this.$route.query.orderId,"_").concat(Date.now());this.composer.downloadComposition(e,"png"),this.showStatus("下载成功","success")}catch(t){this.showStatus("下载失败","error")}},handleSave:function(){var e=Object(r["a"])(Object(s["a"])().m((function e(){return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:this.$message.info("保存中...");case 1:return e.a(2)}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),showStatus:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";this.compositionStatus={message:e,type:i},setTimeout((function(){t.compositionStatus=null}),f)},handleKeyboard:function(e){if(this.isInteractiveMode)switch(e.key){case"Delete":case"Backspace":e.preventDefault(),this.deleteSelectedImage();break;case"Escape":e.preventDefault(),this.toggleInteractiveMode();break;case"r":case"R":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.resetImageScale());break;case"0":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.resetImageScale());break;case"=":case"+":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.scaleSelectedImage(1.2));break;case"-":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.scaleSelectedImage(.8));break}},scaleSelectedImage:function(e){var t=this.composer.getInteractiveCanvas();if(t&&t.selectedObject){var i=t.selectedObject.scale,n=i*e;t.setSelectedScale(n)}}}},p=m,b=(i("43192"),i("2877")),w=Object(b["a"])(p,n,a,!1,null,"0432bd7c",null);t["default"]=w.exports},"1ccb":function(e,t,i){"use strict";i("69cb")},"2ae8":function(e,t,i){},"2db9":function(e,t,i){},4119:function(e,t,i){},43192:function(e,t,i){"use strict";i("4119")},"4d8d":function(e,t,i){},"52c2":function(e,t,i){"use strict";i.r(t),i.d(t,"calculateCanvasDisplaySize",(function(){return l})),i.d(t,"initCanvas",(function(){return u})),i.d(t,"setCanvasScale",(function(){return d})),i.d(t,"getCanvasScale",(function(){return g})),i.d(t,"fitCanvasToContainer",(function(){return v})),i.d(t,"addCanvasZoomControls",(function(){return f})),i.d(t,"loadImage",(function(){return m})),i.d(t,"calculateImageSize",(function(){return p})),i.d(t,"drawImage",(function(){return b})),i.d(t,"composeNineGrid",(function(){return w})),i.d(t,"composeFreeLayout",(function(){return x})),i.d(t,"exportCanvas",(function(){return k})),i.d(t,"downloadCanvas",(function(){return I})),i.d(t,"InteractiveCanvas",(function(){return T})),i.d(t,"createInteractiveCanvas",(function(){return j})),i.d(t,"LayoutManager",(function(){return C})),i.d(t,"calculateAspectRatioLayout",(function(){return S})),i.d(t,"AdvancedComposer",(function(){return _})),i.d(t,"createAdvancedComposer",(function(){return M}));i("5df3"),i("6762"),i("2fdb"),i("6c7b");var n=i("2d63"),a=(i("ac6a"),i("75fc")),s=(i("55dd"),i("7514"),i("43ca")),r=(i("96cf"),i("db72")),o=i("d225"),c=i("b0b4"),h=i("3b8d");function l(e,t,i,n){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=i/e,r=n/t,o=Math.min(s,r,a),c=.1;o=Math.max(o,c);var h=e*o,l=t*o;return{scale:o,displayWidth:h,displayHeight:l,originalWidth:e,originalHeight:t}}function u(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=n.autoScale,s=void 0===a||a,r=n.maxScale,o=void 0===r?1:r,c=n.containerSelector,h=void 0===c?null:c,u=n.pixelRatio,d=void 0===u?window.devicePixelRatio||1:u,g=document.getElementById(e)||document.querySelector('canvas[canvas-id="'.concat(e,'"]'));if(!g)throw new Error("找不到ID为 ".concat(e," 的画布元素"));var v={scale:1,displayWidth:t,displayHeight:i,originalWidth:t,originalHeight:i};if(s){var f,m;if(h){var p=document.querySelector(h);p&&(f=p.clientWidth-40,m=p.clientHeight-40)}else{var b=g.parentElement;b&&(f=b.clientWidth-40,m=b.clientHeight-100)}f&&m&&(v=l(t,i,f,m,o))}g.width=t*d,g.height=i*d,g.style.width=v.displayWidth+"px",g.style.height=v.displayHeight+"px";var w=g.getContext("2d");return w.scale(d,d),w.fillStyle="#ffffff",w.fillRect(0,0,t,i),v.originalWidth=t,v.originalHeight=i,g._displayInfo=v,g._pixelRatio=d,{canvas:g,ctx:w,displayInfo:v}}function d(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=document.getElementById(e)||document.querySelector('canvas[canvas-id="'.concat(e,'"]'));if(n&&n._displayInfo){var a=n._displayInfo,s=a.originalWidth*t,r=a.originalHeight*t;if(n.style.width=s+"px",n.style.height=r+"px",a.scale=t,a.displayWidth=s,a.displayHeight=r,i&&n.parentElement){var o=n.parentElement,c=o.clientWidth,h=o.clientHeight;Math.max(0,(c-s)/2),Math.max(0,(h-r)/2)}}}function g(e){var t=document.getElementById(e)||document.querySelector('canvas[canvas-id="'.concat(e,'"]'));return t?t._displayInfo:null}function v(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=document.getElementById(e)||document.querySelector('canvas[canvas-id="'.concat(e,'"]'));if(n&&n._displayInfo){var a,s=n._displayInfo;if(a=t?document.querySelector(t):n.parentElement,a){var r=a.clientWidth-40,o=a.clientHeight-100,c=l(s.originalWidth,s.originalHeight,r,o,i);d(e,c.scale)}}}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t.minScale,n=void 0===i?.1:i,a=t.maxScale,s=void 0===a?3:a,r=t.zoomStep,o=void 0===r?.1:r;return{zoomIn:function(){var t=g(e);if(t){var i=Math.min(t.scale+o,s);d(e,i)}},zoomOut:function(){var t=g(e);if(t){var i=Math.max(t.scale-o,n);d(e,i)}},zoomToFit:function(){v(e,null,s)},zoomToActualSize:function(){d(e,1)},getZoomLevel:function(){var t=g(e);return t?t.scale:1}}}function m(e){return new Promise((function(t,i){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){return t(n)},n.onerror=function(t){return i(new Error("图片加载失败: ".concat(e)))},n.src=e}))}function p(e,t,i,n){var a,s,r,o,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"cover",h=0,l=0,u=e,d=t;switch(c){case"cover":var g=Math.max(i/e,n/t);a=i,s=n,r=0,o=0,u=i/g,d=n/g,h=(e-u)/2,l=(t-d)/2;break;case"contain":var v=Math.min(i/e,n/t);a=e*v,s=t*v,r=(i-a)/2,o=(n-s)/2;break;case"fill":a=i,s=n,r=0,o=0;break;default:throw new Error("不支持的适配模式: ".concat(c))}return{sourceX:h,sourceY:l,sourceWidth:u,sourceHeight:d,drawX:r,drawY:o,drawWidth:a,drawHeight:s}}function b(e,t,i,n,a,s){var r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"cover",o=p(t.width,t.height,a,s,r);e.drawImage(t,o.sourceX,o.sourceY,o.sourceWidth,o.sourceHeight,i+o.drawX,n+o.drawY,o.drawWidth,o.drawHeight)}function w(e,t){return y.apply(this,arguments)}function y(){return y=Object(h["a"])(Object(s["a"])().m((function e(t,i){var n,a,r,o,c,h,l,d,g,v,f,p,w,y,x,O,k,I,T,j,C,S,_,M,E,R,z=arguments;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:n=z.length>2&&void 0!==z[2]?z[2]:{},a=n.width,r=void 0===a?800:a,o=n.height,c=void 0===o?800:o,h=n.padding,l=void 0===h?10:h,d=n.backgroundColor,g=void 0===d?"#ffffff":d,v=n.mode,f=void 0===v?"cover":v,e.p=1,p=u(t,r,c),w=p.canvas,y=p.ctx,y.fillStyle=g,y.fillRect(0,0,r,c),x=Math.min(i.length,9),O=Math.ceil(Math.sqrt(x)),k=Math.ceil(x/O),I=(r-l*(O+1))/O,T=(c-l*(k+1))/k,j=0;case 2:if(!(j<x)){e.n=8;break}if(i[j]){e.n=3;break}return e.a(3,7);case 3:return C=Math.floor(j/O),S=j%O,_=l+S*(I+l),M=l+C*(T+l),e.p=4,e.n=5,m(i[j].src||i[j].thumbnail||i[j]);case 5:E=e.v,b(y,E,_,M,I,T,f),e.n=7;break;case 6:e.p=6,e.v,y.fillStyle="#f0f0f0",y.fillRect(_,M,I,T),y.strokeStyle="#ddd",y.strokeRect(_,M,I,T);case 7:j++,e.n=2;break;case 8:return e.a(2,w);case 9:throw e.p=9,R=e.v,R;case 10:return e.a(2)}}),e,null,[[4,6],[1,9]])}))),y.apply(this,arguments)}function x(e,t){return O.apply(this,arguments)}function O(){return O=Object(h["a"])(Object(s["a"])().m((function e(t,i){var r,o,c,h,l,d,g,v,f,p,w,y,x,O,k,I,T,j=arguments;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:r=j.length>2&&void 0!==j[2]?j[2]:{},o=r.width,c=void 0===o?800:o,h=r.height,l=void 0===h?600:h,d=r.backgroundColor,g=void 0===d?"#ffffff":d,e.p=1,v=u(t,c,l),f=v.canvas,p=v.ctx,p.fillStyle=g,p.fillRect(0,0,c,l),w=Object(a["a"])(i).sort((function(e,t){return(e.zIndex||0)-(t.zIndex||0)})),y=Object(n["a"])(w),e.p=2,y.s();case 3:if((x=y.n()).done){e.n=8;break}return O=x.value,e.p=4,e.n=5,m(O.src||O.thumbnail||O.url);case 5:k=e.v,O.rotation?(p.save(),p.translate(O.x+O.width/2,O.y+O.height/2),p.rotate(O.rotation*Math.PI/180),b(p,k,-O.width/2,-O.height/2,O.width,O.height,O.mode||"cover"),p.restore()):b(p,k,O.x,O.y,O.width,O.height,O.mode||"cover"),e.n=7;break;case 6:e.p=6,e.v;case 7:e.n=3;break;case 8:e.n=10;break;case 9:e.p=9,I=e.v,y.e(I);case 10:return e.p=10,y.f(),e.f(10);case 11:return e.a(2,f);case 12:throw e.p=12,T=e.v,T;case 13:return e.a(2)}}),e,null,[[4,6],[2,9,10,11],[1,12]])}))),O.apply(this,arguments)}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"png",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.9;return e.toDataURL("image/".concat(t),i)}function I(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"composition",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"png",n=k(e,i),a=document.createElement("a");a.download="".concat(t,".").concat(i),a.href=n,a.click()}var T=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object(o["a"])(this,e),this.canvasId=t,this.canvas=document.getElementById(t)||document.querySelector('canvas[canvas-id="'.concat(t,'"]')),this.ctx=this.canvas.getContext("2d"),this.options=Object(r["a"])({enableDrag:!0,enableResize:!0,enableWheelZoom:!0,showBorders:!0,borderColor:"#1890ff",borderWidth:2,handleSize:8,handleColor:"#ffffff",handleBorderColor:"#1890ff",wheelZoomSpeed:.1,minScale:.1,maxScale:5},i),this.debugMode=i.debug||!1,this.imageObjects=[],this.selectedObject=null,this.isDragging=!1,this.isResizing=!1,this.dragStartPos={x:0,y:0},this.resizeHandle=null,this.isEditMode=!1,this.mousePos={x:0,y:0},this.canvas._displayInfo||(this.canvas._displayInfo={scale:1,displayWidth:this.canvas.width,displayHeight:this.canvas.height,originalWidth:this.canvas.width,originalHeight:this.canvas.height}),this.canvas._pixelRatio||(this.canvas._pixelRatio=window.devicePixelRatio||1),this.bindEvents()}return Object(c["a"])(e,[{key:"addImageObject",value:function(){var e=Object(h["a"])(Object(s["a"])().m((function e(t){var i,n,a,r,o,c,h=arguments;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return i=h.length>1&&void 0!==h[1]?h[1]:{},e.n=1,m(t);case 1:return n=e.v,a=this.calculateAspectRatioSize(n.naturalWidth,n.naturalHeight,i.width||200,i.height||150,!1!==i.preserveAspectRatio),r=a.width,o=a.height,c={id:Date.now()+Math.random(),img:n,src:t,x:i.x||50,y:i.y||50,width:r,height:o,rotation:i.rotation||0,mode:i.mode||"cover",selected:!1,zIndex:i.zIndex||this.imageObjects.length,clipRegion:i.clipRegion||null,scale:i.scale||1,originalWidth:r,originalHeight:o},this.imageObjects.push(c),this.redraw(),e.a(2,c)}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"calculateAspectRatioSize",value:function(e,t,i,n){var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!a)return{width:i,height:n};var s,r,o=e/t,c=i/n;return o>c?(s=i,r=i/o):(r=n,s=n*o),{width:s,height:r}}},{key:"removeImageObject",value:function(e){this.imageObjects=this.imageObjects.filter((function(t){return t.id!==e})),this.selectedObject&&this.selectedObject.id===e&&(this.selectedObject=null),this.redraw()}},{key:"clearAll",value:function(){this.imageObjects=[],this.selectedObject=null,this.redraw()}},{key:"updateImageClipRegion",value:function(e,t){var i=this.imageObjects.find((function(t){return t.id===e}));i&&(i.clipRegion=t,this.redraw())}},{key:"getImageObject",value:function(e){return this.imageObjects.find((function(t){return t.id===e}))}},{key:"redraw",value:function(){var e=this;this.backgroundImage||this.saveBackground(),this.restoreBackground();var t=Object(a["a"])(this.imageObjects).sort((function(e,t){return e.zIndex-t.zIndex}));t.forEach((function(t){e.drawImageObject(t),t.selected&&e.options.showBorders&&(e.drawSelectionBorder(t),e.options.enableResize&&e.drawResizeHandles(t))}))}},{key:"saveBackground",value:function(){this.backgroundImage=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height)}},{key:"restoreBackground",value:function(){this.backgroundImage?this.ctx.putImageData(this.backgroundImage,0,0):(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}},{key:"updateBackground",value:function(){this.backgroundImage=null,this.saveBackground()}},{key:"drawImageObject",value:function(e){this.ctx.save(),this.ctx.beginPath(),e.clipRegion?this.ctx.rect(e.clipRegion.x,e.clipRegion.y,e.clipRegion.width,e.clipRegion.height):this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.clip(),e.rotation?(this.ctx.translate(e.x+e.width/2,e.y+e.height/2),this.ctx.rotate(e.rotation*Math.PI/180),b(this.ctx,e.img,-e.width/2,-e.height/2,e.width,e.height,e.mode)):b(this.ctx,e.img,e.x,e.y,e.width,e.height,e.mode),this.ctx.restore()}},{key:"drawSelectionBorder",value:function(e){this.ctx.save(),this.ctx.beginPath(),e.clipRegion?this.ctx.rect(e.clipRegion.x,e.clipRegion.y,e.clipRegion.width,e.clipRegion.height):this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.clip(),this.ctx.strokeStyle=this.options.borderColor,this.ctx.lineWidth=this.options.borderWidth,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(e.x,e.y,e.width,e.height),this.ctx.setLineDash([]),this.ctx.restore()}},{key:"drawResizeHandles",value:function(e){var t=this,i=this.getResizeHandles(e);this.ctx.save(),i.forEach((function(i){var n=!1;n=e.clipRegion?i.x>=e.clipRegion.x&&i.x<=e.clipRegion.x+e.clipRegion.width&&i.y>=e.clipRegion.y&&i.y<=e.clipRegion.y+e.clipRegion.height:i.x>=0&&i.x<=t.canvas.width&&i.y>=0&&i.y<=t.canvas.height,n&&(t.ctx.fillStyle=t.options.handleColor,t.ctx.strokeStyle=t.options.handleBorderColor,t.ctx.lineWidth=1,t.ctx.fillRect(i.x-t.options.handleSize/2,i.y-t.options.handleSize/2,t.options.handleSize,t.options.handleSize),t.ctx.strokeRect(i.x-t.options.handleSize/2,i.y-t.options.handleSize/2,t.options.handleSize,t.options.handleSize))})),this.ctx.restore()}},{key:"getResizeHandles",value:function(e){return[{x:e.x,y:e.y,type:"nw"},{x:e.x+e.width,y:e.y,type:"ne"},{x:e.x,y:e.y+e.height,type:"sw"},{x:e.x+e.width,y:e.y+e.height,type:"se"}]}},{key:"bindEvents",value:function(){this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.addEventListener("click",this.onClick.bind(this)),this.canvas.addEventListener("wheel",this.onWheel.bind(this)),this.canvas.addEventListener("contextmenu",(function(e){return e.preventDefault()}))}},{key:"getMousePos",value:function(e){var t,i=this.canvas.getBoundingClientRect(),n=this.canvas._displayInfo,a=this.canvas._pixelRatio||1;if(n){var s=n.originalWidth/i.width,r=n.originalHeight/i.height;t={x:(e.clientX-i.left)*s,y:(e.clientY-i.top)*r}}else{var o=this.canvas.width/a/i.width,c=this.canvas.height/a/i.height;t={x:(e.clientX-i.left)*o,y:(e.clientY-i.top)*c}}return this.debugMode,t}},{key:"hitTest",value:function(e){var t=Object(a["a"])(this.imageObjects).sort((function(e,t){return t.zIndex-e.zIndex}));this.debugMode;var i,s=Object(n["a"])(t);try{for(s.s();!(i=s.n()).done;){var r=i.value;if(e.x>=r.x&&e.x<=r.x+r.width&&e.y>=r.y&&e.y<=r.y+r.height)return r}}catch(o){s.e(o)}finally{s.f()}return null}},{key:"hitTestResizeHandle",value:function(e,t){if(!t)return null;var i,a=this.getResizeHandles(t),s=this.options.handleSize,r=Object(n["a"])(a);try{for(r.s();!(i=r.n()).done;){var o=i.value;if(Math.abs(e.x-o.x)<=s/2&&Math.abs(e.y-o.y)<=s/2)return o.type}}catch(c){r.e(c)}finally{r.f()}return null}},{key:"onMouseDown",value:function(e){if(this.isEditMode){if(this.mousePos=this.getMousePos(e),this.dragStartPos=Object(r["a"])({},this.mousePos),this.selectedObject&&(this.resizeHandle=this.hitTestResizeHandle(this.mousePos,this.selectedObject),this.resizeHandle))return this.isResizing=!0,void(this.canvas.style.cursor=this.getResizeCursor(this.resizeHandle));var t=this.hitTest(this.mousePos);t?(this.selectObject(t),this.isDragging=!0,this.canvas.style.cursor="move"):this.selectObject(null)}}},{key:"onMouseMove",value:function(e){this.mousePos=this.getMousePos(e),this.isEditMode?this.isResizing&&this.selectedObject?this.handleResize():this.isDragging&&this.selectedObject?this.handleDrag():this.updateCursor():this.canvas.style.cursor="default"}},{key:"onMouseUp",value:function(e){this.isDragging=!1,this.isResizing=!1,this.resizeHandle=null,this.isEditMode?this.updateCursor():this.canvas.style.cursor="default"}},{key:"onClick",value:function(e){}},{key:"onWheel",value:function(e){if(this.options.enableWheelZoom&&this.isEditMode){e.preventDefault();var t=this.getMousePos(e);this.selectedObject&&this.isMouseOverObject(t,this.selectedObject)&&this.handleWheelZoom(e,t)}}},{key:"isMouseOverObject",value:function(e,t){return e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height}},{key:"handleWheelZoom",value:function(e,t){var i=this.selectedObject;if(i){var n=e.deltaY,a=n<0,s=a?1+this.options.wheelZoomSpeed:1-this.options.wheelZoomSpeed,r=i.scale*s,o=Math.max(this.options.minScale,Math.min(this.options.maxScale,r));if(o!==i.scale){var c=i.originalWidth*o,h=i.originalHeight*o,l={x:t.x-i.x,y:t.y-i.y},u=l.x/i.width,d=l.y/i.height,g=t.x-c*u,v=t.y-h*d;i.scale=o,i.width=c,i.height=h,i.x=g,i.y=v,this.debugMode,this.redraw()}}}},{key:"handleDrag",value:function(){if(this.selectedObject){var e=this.mousePos.x-this.dragStartPos.x,t=this.mousePos.y-this.dragStartPos.y;this.selectedObject.x+=e,this.selectedObject.y+=t,this.dragStartPos=Object(r["a"])({},this.mousePos),this.redraw()}}},{key:"handleResize",value:function(){if(this.selectedObject&&this.resizeHandle){var e=this.mousePos.x-this.dragStartPos.x,t=this.mousePos.y-this.dragStartPos.y,i=this.selectedObject;switch(this.resizeHandle){case"nw":i.x+=e,i.y+=t,i.width-=e,i.height-=t;break;case"ne":i.y+=t,i.width+=e,i.height-=t;break;case"sw":i.x+=e,i.width-=e,i.height+=t;break;case"se":i.width+=e,i.height+=t;break}i.width=Math.max(20,i.width),i.height=Math.max(20,i.height),i.scale=Math.max(i.width/i.originalWidth,i.height/i.originalHeight);var n=i.originalWidth/i.originalHeight;i.width/i.height>n?i.height=i.width/n:i.width=i.height*n,this.dragStartPos=Object(r["a"])({},this.mousePos),this.redraw()}}},{key:"updateCursor",value:function(){if(this.isEditMode){if(this.selectedObject){var e=this.hitTestResizeHandle(this.mousePos,this.selectedObject);if(e)return void(this.canvas.style.cursor=this.getResizeCursor(e))}var t=this.hitTest(this.mousePos);this.canvas.style.cursor=t?"move":"default"}else this.canvas.style.cursor="default"}},{key:"getResizeCursor",value:function(e){var t={nw:"nw-resize",ne:"ne-resize",sw:"sw-resize",se:"se-resize"};return t[e]||"default"}},{key:"selectObject",value:function(e){this.imageObjects.forEach((function(e){return e.selected=!1})),e?(e.selected=!0,this.selectedObject=e):this.selectedObject=null,this.redraw()}},{key:"deleteSelected",value:function(){this.selectedObject&&this.removeImageObject(this.selectedObject.id)}},{key:"resetSelectedScale",value:function(){if(this.selectedObject){var e=this.selectedObject,t=e.x+e.width/2,i=e.y+e.height/2;e.scale=1,e.width=e.originalWidth,e.height=e.originalHeight,e.x=t-e.width/2,e.y=i-e.height/2,this.redraw()}}},{key:"setSelectedScale",value:function(e){if(this.selectedObject){var t=this.selectedObject,i=Math.max(this.options.minScale,Math.min(this.options.maxScale,e)),n=t.x+t.width/2,a=t.y+t.height/2;t.scale=i,t.width=t.originalWidth*i,t.height=t.originalHeight*i,t.x=n-t.width/2,t.y=a-t.height/2,this.redraw()}}},{key:"setEditMode",value:function(e){this.isEditMode=e,e||(this.isDragging=!1,this.isResizing=!1,this.resizeHandle=null,this.selectObject(null),this.canvas.style.cursor="default"),this.redraw()}},{key:"getEditMode",value:function(){return this.isEditMode}},{key:"toggleEditMode",value:function(){return this.setEditMode(!this.isEditMode),this.isEditMode}},{key:"exportCanvas",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"png",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.9;return k(this.canvas,e,t)}}])}();function j(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new T(e,t)}var C=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object(o["a"])(this,e),this.canvasId=t,this.templateType=i,this.canvas=document.getElementById(t)||document.querySelector('canvas[canvas-id="'.concat(t,'"]')),this.ctx=this.canvas.getContext("2d"),this.config=Object(r["a"])({width:600,height:600,padding:20,backgroundColor:"#ffffff"},n),this.templateLimits={nine_grid:9,compare:2,timeline:20}}return Object(c["a"])(e,[{key:"validateImages",value:function(e,t){if(0===e.length)return{valid:!1,message:"请先选择要合成的图片"};var i=this.templateLimits[this.templateType]||9,n={nine_grid:"九宫格",compare:"对比图",timeline:"时光轴"},a=n[this.templateType]||"模板";switch(this.templateType){case"compare":if(2!==e.length)return{valid:!1,message:"对比图需要选择2张图片"};break;case"nine_grid":if(e.length>i)return{valid:!1,message:"".concat(a,"最多支持").concat(i,"张图片")};break;case"timeline":if(0===e.length)return{valid:!1,message:"时光轴至少需要1张图片"};break}return{valid:!0,message:""}}},{key:"drawTemplateBackground",value:function(e){var t=this;this.ctx.clearRect(0,0,this.config.width,this.config.height),this.ctx.fillStyle=this.config.backgroundColor,this.ctx.fillRect(0,0,this.config.width,this.config.height);var i={nine_grid:function(){return t.drawNineGridBackground(e)},compare:function(){return t.drawComparisonBackground()},timeline:function(){return t.drawTimelineBackground(e)}},n=i[this.templateType];n&&n()}},{key:"drawNineGridBackground",value:function(e){var t=10,i=Math.ceil(Math.sqrt(e.length)),n=Math.ceil(e.length/i),a=(this.config.width-t*(i+1))/i,s=(this.config.height-t*(n+1))/n;this.ctx.strokeStyle="#e8e8e8",this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);for(var r=0;r<e.length&&r<9;r++){var o=Math.floor(r/i),c=r%i,h=t+c*(a+t),l=t+o*(s+t);this.ctx.strokeRect(h,l,a,s),this.ctx.fillStyle="#cccccc",this.ctx.font="14px Arial",this.ctx.textAlign="center",this.ctx.fillText("".concat(r+1),h+a/2,l+s/2)}this.ctx.setLineDash([])}},{key:"drawComparisonBackground",value:function(){var e=20,t=2,i=(this.config.width-2*e-t)/2,n=this.config.height-2*e,a=this.config.width/2;this.ctx.fillStyle="#e8e8e8",this.ctx.fillRect(a-t/2,0,t,this.config.height),this.ctx.strokeStyle="#e8e8e8",this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]),this.ctx.strokeRect(e,e,i,n),this.ctx.fillStyle="#cccccc",this.ctx.font="16px Arial",this.ctx.textAlign="center",this.ctx.fillText("图片 1",e+i/2,e+n/2),this.ctx.strokeRect(a+t/2,e,i,n),this.ctx.fillText("图片 2",a+t/2+i/2,e+n/2),this.ctx.setLineDash([])}},{key:"drawTimelineBackground",value:function(e){var t=150,i=20;this.ctx.fillStyle="#f8f9fa",this.ctx.fillRect(0,0,t,this.config.height),this.ctx.fillStyle="#e9ecef",this.ctx.fillRect(t-2,0,2,this.config.height),this.ctx.strokeStyle="#e8e8e8",this.ctx.lineWidth=1,this.ctx.setLineDash([5,5]);for(var n=t+i,a=460,s=0;s<e.length;s++){var r=i+s*a;this.ctx.fillStyle="#e9ecef",this.ctx.beginPath(),this.ctx.arc(t-1,r+200,4,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeRect(n,r,this.config.width-n-i,400),this.ctx.fillStyle="#cccccc",this.ctx.font="14px Arial",this.ctx.textAlign="center",this.ctx.fillText("时间 ".concat(s+1),t/2,r+200)}this.ctx.setLineDash([])}},{key:"calculateImagePosition",value:function(e,t){var i=this,n=20,a={nine_grid:function(){return i.calculateNineGridPosition(e,t,n)},compare:function(){return i.calculateComparePosition(e,n)},timeline:function(){return i.calculateTimelinePosition(e,n)}},s=a[this.templateType];return s?s():this.calculateDefaultPosition(e)}},{key:"calculateNineGridPosition",value:function(e,t,i){var n=Math.ceil(Math.sqrt(t.length)),a=(this.config.width-i*(n+1))/n,s=(this.config.height-i*(Math.ceil(t.length/n)+1))/Math.ceil(t.length/n),r=Math.floor(e/n),o=e%n;return{x:i+o*(a+i),y:i+r*(s+i),width:a,height:s}}},{key:"calculateComparePosition",value:function(e,t){var i=(this.config.width-3*t)/2,n=this.config.height-2*t;return{x:0===e?t:2*t+i,y:t,width:i,height:n}}},{key:"calculateTimelinePosition",value:function(e,t){var i=150,n=400,a=60;return{x:i+t+e%5*(n+10),y:t+Math.floor(e/5)*(n+a),width:n,height:n}}},{key:"calculateDefaultPosition",value:function(e){return{x:50+e%3*200,y:50+150*Math.floor(e/3),width:180,height:120}}}])}();function S(e,t,i,n){var a,s,r=e/t,o=i/n,c=0,h=0;return r>o?(a=i,s=i/r,h=(n-s)/2):(s=n,a=n*r,c=(i-a)/2),{actualWidth:a,actualHeight:s,offsetX:c,offsetY:h}}var _=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Object(o["a"])(this,e),this.canvasId=t,this.templateType=i,this.layoutManager=new C(t,i,n),this.interactiveCanvas=null,this.options=Object(r["a"])({preserveAspectRatio:!0,enableInteractive:!0},n)}return Object(c["a"])(e,[{key:"createInteractiveCanvas",value:function(){var e=Object(h["a"])(Object(s["a"])().m((function e(){var t;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:return e.p=0,e.n=1,new Promise((function(e){return setTimeout(e,0)}));case 1:return this.interactiveCanvas=j(this.canvasId,{enableDrag:!0,enableResize:!0,enableWheelZoom:!0,showBorders:!1,borderColor:"#1890ff",borderWidth:2,handleSize:10,wheelZoomSpeed:.15,minScale:.2,maxScale:3,debug:!1}),e.a(2,this.interactiveCanvas);case 2:throw e.p=2,t=e.v,t;case 3:return e.a(2)}}),e,this,[[0,2]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"generateComposition",value:function(){var e=Object(h["a"])(Object(s["a"])().m((function e(t,i){var n,a;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:if(e.p=0,n=this.layoutManager.validateImages(t,i),n.valid){e.n=1;break}return e.a(2,{success:!1,message:n.message});case 1:if(this.layoutManager.drawTemplateBackground(t),!this.options.enableInteractive){e.n=3;break}return e.n=2,this.createInteractiveCanvas();case 2:this.interactiveCanvas.updateBackground(),this.interactiveCanvas.clearAll();case 3:return e.n=4,this.addImagesToLayout(t,i);case 4:return e.a(2,{success:!0,message:"合成成功！使用了 ".concat(t.length," 张图片")});case 5:return e.p=5,a=e.v,e.a(2,{success:!1,message:"合成失败: "+a.message})}}),e,this,[[0,5]])})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"addImagesToLayout",value:function(){var e=Object(h["a"])(Object(s["a"])().m((function e(t,i){var n,a,r=this;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:if(this.interactiveCanvas){e.n=1;break}return e.a(2);case 1:return n=i.filter((function(e){return t.includes(e.id)})),a=n.map(function(){var e=Object(h["a"])(Object(s["a"])().m((function e(i,n){var a,o,c,h,l,u,d,g;return Object(s["a"])().w((function(e){while(1)switch(e.n){case 0:if(a=r.layoutManager.calculateImagePosition(n,t),o={mode:"cover",preserveAspectRatio:r.options.preserveAspectRatio,clipRegion:{x:a.x,y:a.y,width:a.width,height:a.height}},!r.options.preserveAspectRatio){e.n=2;break}return e.n=1,m(i.url);case 1:c=e.v,h=S(c.naturalWidth,c.naturalHeight,a.width,a.height),l=h.actualWidth,u=h.actualHeight,d=h.offsetX,g=h.offsetY,o.x=a.x+d,o.y=a.y+g,o.width=l,o.height=u,e.n=3;break;case 2:o.x=a.x,o.y=a.y,o.width=a.width,o.height=a.height;case 3:return e.n=4,r.interactiveCanvas.addImageObject(i.url,o);case 4:return e.a(2,e.v)}}),e)})));return function(t,i){return e.apply(this,arguments)}}()),e.n=2,Promise.all(a);case 2:return e.a(2)}}),e,this)})));function t(t,i){return e.apply(this,arguments)}return t}()},{key:"setEditMode",value:function(e){this.interactiveCanvas&&(this.interactiveCanvas.setEditMode(e),this.interactiveCanvas.options.showBorders=e)}},{key:"getInteractiveCanvas",value:function(){return this.interactiveCanvas}},{key:"exportComposition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"png",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.9,i=document.getElementById(this.canvasId);return k(i,e,t)}},{key:"downloadComposition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"composition",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"png",i=document.getElementById(this.canvasId);I(i,e,t)}}])}();function M(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new _(e,t,i)}},"69cb":function(e,t,i){},"89c9":function(e,t,i){"use strict";i("2db9")},"9b5d":function(e,t,i){"use strict";i.r(t),i.d(t,"TEMPLATE_TYPE_ENUM",(function(){return n})),i.d(t,"TEMPLATE_TYPE_OPTIONS",(function(){return a})),i.d(t,"getTemplateTypeLabel",(function(){return s})),i.d(t,"getTemplateTypeTagType",(function(){return r})),i.d(t,"getTemplateTypePhotoNumber",(function(){return o})),i.d(t,"TEMPLATE_TYPE_MAP",(function(){return c}));i("7514");var n={TIMELINE:"timeline",NINE_GRID:"nine_grid",COMPARE:"compare",GIF:"gif",VIDEO:"video"},a=[{value:n.TIMELINE,label:"时光轴",color:"primary",width:"2480",height:"3508"},{value:n.NINE_GRID,label:"九宫格",color:"success",number:9,width:"1240",height:"1754"},{value:n.COMPARE,label:"对比图",color:"warning",number:2,width:"1240",height:"1754"},{value:n.GIF,label:"GIF",color:"danger"},{value:n.VIDEO,label:"视频",color:"info"}];function s(e){var t=a.find((function(t){return t.value===e}));return t?t.label:"未知"}function r(e){var t=a.find((function(t){return t.value===e}));return t?t.color:""}function o(e){var t=a.find((function(t){return t.value===e}));return t&&t.number?t.number:null}var c=a.reduce((function(e,t){return e[t.value]=t,e}),{})},b67c:function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"select-all-container"},[i("label",[i("input",{attrs:{type:"checkbox"},domProps:{checked:e.isAllSelected},on:{change:e.handleToggle}}),e._v("\n    全选 ("+e._s(e.selectedCount)+"/"+e._s(e.totalCount)+")\n  ")])])},a=[],s=(i("c5f6"),{name:"ImageSelectAll",props:{isAllSelected:{type:Boolean,required:!0},selectedCount:{type:Number,required:!0},totalCount:{type:Number,required:!0}},methods:{handleToggle:function(){this.$emit("toggle")}}}),r=s,o=(i("ee81"),i("2877")),c=Object(o["a"])(r,n,a,!1,null,"15cc3df6",null);t["default"]=c.exports},b829:function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"list-container"},e._l(e.images,(function(t){return i("div",{key:t.id,staticClass:"image-item",class:{selected:e.selectedImages.includes(t.id)},on:{click:function(i){return e.handleImageClick(t.id)}}},[i("div",{staticClass:"image-thumbnail"},[i("img",{attrs:{src:t.url,alt:t.name}}),e._v(" "),i("div",{staticClass:"image-overlay"},[i("span",{staticClass:"image-name"},[e._v(e._s(t.name))]),e._v(" "),i("span",{staticClass:"image-status",class:t.status},[e._v(e._s(e.getStatusText(t.status)))])]),e._v(" "),e.selectedImages.includes(t.id)?i("div",{staticClass:"selected-mark"},[e._v("✓")]):e._e()])])})),0)},a=[],s={name:"ImageGrid",props:{images:{type:Array,required:!0},selectedImages:{type:Array,required:!0}},methods:{handleImageClick:function(e){this.$emit("toggle-selection",e)},getStatusText:function(e){var t={completed:"已完成",generating:"生成中",pending:"待处理",error:"错误"};return t[e]||e}}},r=s,o=(i("89c9"),i("2877")),c=Object(o["a"])(r,n,a,!1,null,"3133a178",null);t["default"]=c.exports},ea6b:function(e,t,i){"use strict";i.r(t);var n=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"template-info",attrs:{"data-template":e.templateType}},[i("div",{staticClass:"template-description"},[i("h4",[e._v(e._s(e.templateDescription.title))]),e._v(" "),i("p",[e._v(e._s(e.templateDescription.description))])])])},a=[],s={name:"TemplateInfo",props:{templateType:{type:String,required:!0}},computed:{templateDescription:function(){var e={nine_grid:{title:"九宫格布局",description:"将1-9张图片排列成网格布局，自动计算行列数"},compare:{title:"对比图布局",description:"左右对比两张图片，清晰展示差异"},timeline:{title:"时光轴布局",description:"按时间顺序展示图片，左侧时间轴右侧图片"},gif:{title:"GIF布局",description:"将图片合成GIF"},video:{title:"视频布局",description:"将图片合成视频"}};return e[this.templateType]||{title:"未知模板",description:"该模板类型暂未支持",imageRequirement:"请选择其他模板"}}}},r=s,o=(i("1ccb"),i("2877")),c=Object(o["a"])(r,n,a,!1,null,"4eaebf86",null);t["default"]=c.exports},ee81:function(e,t,i){"use strict";i("2ae8")},f779:function(e,t,i){"use strict";i("4d8d")},f8b7:function(e,t,i){"use strict";i.d(t,"c",(function(){return s})),i.d(t,"b",(function(){return o}));var n=i("b775");function a(e){return Object(n["a"])({url:"api/photo/page",method:"get",params:e})}function s(e){return Object(n["a"])({url:"api/photo/info/"+e,method:"get"})}function r(e){return Object(n["a"])({url:"api/photo/updateOrder",method:"post",data:e})}function o(e){return Object(n["a"])({url:"/api/photo/getPhotoCalendarList/"+e,method:"get"})}t["a"]={page:a,info:s,make:r}}}]);